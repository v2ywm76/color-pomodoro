<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Visual Timer</title>
  <meta name="theme-color" content="#ffffff" />
  <style>
    :root{
      /* ① 背景色・枠は白 */
      --bg:#ffffff;
      --text:#111827;
      --muted:#6b7280;

      /* 進捗（0〜1）と色はJSで更新 */
      --pct: 1;
      --accent: hsl(205 82% 55%);

      /* 薄い枠＆影（白背景用） */
      --rim: rgba(0,0,0,.10);
      --rest: rgba(17,24,39,.08);
      --shadow: 0 20px 70px rgba(0,0,0,.12);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
      display:flex;
      justify-content:center;
      align-items:center;
      padding:20px;
    }

    .wrap{
      width:min(960px, 100%);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:18px;
    }

    /* ===== 円（円内全体を塗る：conic-gradient） ===== */
    .dial{
      width:min(78vmin, 560px);           /* 大きく表示 */
      aspect-ratio:1/1;
      border-radius:50%;
      position:relative;
      box-shadow: var(--shadow);
      display:grid;
      place-items:center;

      background: #ffffff;               /* 外枠も白 */
      border: 1px solid var(--rim);      /* 薄い枠線 */
    }

    /* 内側の「面」：ここが塗られて減っていく */
    .face{
      width: 82%;
      height: 82%;
      border-radius:50%;
      position:relative;

      /* ② 時計回り + 頂点（12時）開始 */
      /* --pct が 1→0 に減ると塗りが減る */
      background:
  conic-gradient(
    from 0deg, /* ←頂点(12時)開始 */
    var(--rest) 0turn,
    var(--rest) calc((1 - var(--pct)) * 1turn), /* 経過が時計回りに増える */
    var(--accent) 0
  );

      box-shadow:
        inset 0 0 0 10px rgba(0,0,0,.05),
        inset 0 18px 40px rgba(0,0,0,.08);
      overflow:hidden;
    }

    /* 内側のハイライト（紙っぽい質感） */
    .face::after{
      content:"";
      position:absolute;
      inset:0;
      border-radius:50%;
      background:
        radial-gradient(circle at 35% 30%, rgba(255,255,255,.55), transparent 45%),
        radial-gradient(circle at 65% 75%, rgba(0,0,0,.10), transparent 55%);
      pointer-events:none;
      mix-blend-mode: overlay;
      opacity:.8;
    }

    /* 中央のノブ */
    .knob{
      width: 32%;
      height: 32%;
      border-radius:50%;
      background: #ffffff;
      border: 1px solid rgba(0,0,0,.10);
      box-shadow:
        0 14px 30px rgba(0,0,0,.12),
        inset 0 1px 0 rgba(255,255,255,.9);
      position:absolute;
      display:grid;
      place-items:center;
    }
    .knobMark{
      width: 42%;
      height: 42%;
      border-radius:50%;
      background: rgba(0,0,0,.14);
      clip-path: polygon(50% 50%, 50% 0%, 72% 10%, 68% 55%);
      transform: rotate(20deg);
      opacity:.9;
    }

    /* 上の小さな点（目印） */
    .dot{
      width:10px; height:10px;
      border-radius:50%;
      background: rgba(0,0,0,.45);
      position:absolute;
      top:6%;
      left:50%;
      transform: translateX(-50%);
      box-shadow: 0 6px 12px rgba(0,0,0,.10);
    }

    /* ===== UI ===== */
    .panel{
      width:min(720px, 100%);
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:center;
    }

    .row{
      width:100%;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      align-items:center;
    }

    .btn{
      appearance:none;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(0,0,0,.03);
      color: var(--text);
      padding:12px 14px;
      border-radius: 14px;
      font-weight:700;
      cursor:pointer;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      user-select:none;
      min-width: 128px;
      text-align:center;
    }
    .btn:hover{background: rgba(0,0,0,.06); border-color: rgba(0,0,0,.18)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      background: color-mix(in oklab, var(--accent) 22%, rgba(0,0,0,.03));
      border-color: color-mix(in oklab, var(--accent) 55%, rgba(0,0,0,.12));
    }
    .btn.danger{
      background: rgba(255, 99, 132, .10);
      border-color: rgba(255, 99, 132, .35);
    }
    .btn:disabled{opacity:.55; cursor:not-allowed}

    .field{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      flex-wrap:wrap;
      color: var(--muted);
      font-size:14px;
    }
    select, input[type="number"]{
      padding:10px 12px;
      border-radius: 12px;
      background: rgba(0,0,0,.03);
      border: 1px solid rgba(0,0,0,.12);
      color: var(--text);
      outline:none;
      width: 150px;
    }

    .hint{
      color: var(--muted);
      font-size: 12px;
      text-align:center;
      line-height:1.5;
    }

    /* ※時間は表示しません（要件どおり） */

    @media (max-width: 520px){
      .btn{min-width: 44%; padding:12px 10px}
      select, input[type="number"]{width: 44%}
    }
  </style>
</head>
<body>
  <main class="wrap">
    <div class="dial" aria-label="visual timer">
      <div class="dot" aria-hidden="true"></div>
      <div class="face" id="face"></div>
      <div class="knob" aria-hidden="true"><div class="knobMark"></div></div>
    </div>

    <section class="panel">
      <div class="field">
        <span>モード</span>
        <select id="mode">
          <option value="focus">Focus</option>
          <option value="break">Break</option>
        </select>

        <span>分</span>
        <input id="minutes" type="number" min="1" max="180" step="1" value="25" />
      </div>

      <div class="row">
        <button class="btn primary" id="startBtn">開始</button>
        <button class="btn" id="pauseBtn" disabled>一時停止</button>
        <button class="btn danger" id="resetBtn">リセット</button>
      </div>

      <div class="hint">
        ショートカット：Space = 開始/一時停止、R = リセット<br/>
        ※時間は表示しません（円の減りだけで把握する設計）
      </div>
    </section>
  </main>

  <script>
    (() => {
      const root = document.documentElement;

      const modeEl   = document.getElementById("mode");
      const minEl    = document.getElementById("minutes");
      const startBtn = document.getElementById("startBtn");
      const pauseBtn = document.getElementById("pauseBtn");
      const resetBtn = document.getElementById("resetBtn");

      // state
      let durationSec = 25 * 60;
      let remainingSec = durationSec;

      let running = false;
      let endAt = null;       // timestamp(ms)
      let ticker = null;

      // settings persistence
      const KEY = "visual_timer_v3_white";
      function load(){
        try{
          const s = JSON.parse(localStorage.getItem(KEY) || "{}");
          if (s.mode) modeEl.value = s.mode;
          if (s.min) minEl.value = s.min;
        }catch{}
      }
      function save(){
        localStorage.setItem(KEY, JSON.stringify({
          mode: modeEl.value,
          min: Number(minEl.value || 25)
        }));
      }

      function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

      // 色：残りが減るほど「白っぽく戻る」
      function setAccent(pct){
        const baseHue = (modeEl.value === "focus") ? 205 : 140;
        const sat = 80;
        const light = clamp(42 + (1 - pct) * 40, 34, 88);
        root.style.setProperty("--accent", `hsl(${baseHue} ${sat}% ${light}%)`);
      }

      function setPct(pct){
        root.style.setProperty("--pct", String(pct));
        setAccent(pct);
      }

      function applyMinutes(){
        const m = clamp(parseInt(minEl.value || "25", 10), 1, 180);
        durationSec = m * 60;
        remainingSec = durationSec;
        endAt = null;
        setPct(1);
      }

      function update(){
        const pct = durationSec ? (remainingSec / durationSec) : 0;
        setPct(pct);
      }

      function tick(){
        if (!running || endAt == null) return;
        const secLeft = Math.max(0, Math.round((endAt - Date.now()) / 1000));
        remainingSec = secLeft;
        update();

        if (secLeft <= 0){
          stop(true);
          flash();
        }
      }

      function start(){
        if (running) return;
        save();

        running = true;
        endAt = Date.now() + remainingSec * 1000;

        ticker = setInterval(tick, 200);

        startBtn.disabled = true;
        pauseBtn.disabled = false;
        pauseBtn.textContent = "一時停止";
      }

      function stop(finished=false){
        running = false;
        clearInterval(ticker);
        ticker = null;

        if (!finished && endAt != null){
          remainingSec = Math.max(0, Math.round((endAt - Date.now()) / 1000));
        }
        endAt = null;

        startBtn.disabled = false;
        pauseBtn.disabled = true;
      }

      function pause(){
        if (!running) return;
        stop(false);

        pauseBtn.disabled = false;
        pauseBtn.textContent = "再開";
        startBtn.disabled = true;
      }

      function resume(){
        if (running) return;
        running = true;
        endAt = Date.now() + remainingSec * 1000;
        ticker = setInterval(tick, 200);

        pauseBtn.textContent = "一時停止";
        startBtn.disabled = true;
        pauseBtn.disabled = false;
      }

      function reset(){
        stop(false);
        applyMinutes();
        update();

        startBtn.disabled = false;
        pauseBtn.disabled = true;
        pauseBtn.textContent = "一時停止";
      }

      function flash(){
        const el = document.createElement("div");
        el.style.position="fixed";
        el.style.inset="0";
        el.style.background="rgba(0,0,0,.08)";
        el.style.zIndex="9999";
        el.style.pointerEvents="none";
        el.style.animation="flash .7s ease forwards";
        const style = document.createElement("style");
        style.textContent = `
          @keyframes flash{
            0%{opacity:0}
            15%{opacity:1}
            100%{opacity:0}
          }
        `;
        document.head.appendChild(style);
        document.body.appendChild(el);
        setTimeout(()=>{ el.remove(); style.remove(); }, 800);
      }

      // events
      modeEl.addEventListener("change", () => { save(); update(); });
      minEl.addEventListener("change", () => { save(); if(!running) applyMinutes(); update(); });

      startBtn.addEventListener("click", start);

      pauseBtn.addEventListener("click", () => {
        if (pauseBtn.textContent.includes("再開")) resume();
        else pause();
      });

      resetBtn.addEventListener("click", reset);

      // keyboard
      window.addEventListener("keydown", (e) => {
        if (e.target && ["INPUT","SELECT","TEXTAREA"].includes(e.target.tagName)) return;
        if (e.code === "Space"){
          e.preventDefault();
          if (running) pause();
          else {
            if (pauseBtn.textContent.includes("再開")) resume();
            else start();
          }
        }
        if (e.key.toLowerCase() === "r") reset();
      });

      // init
      load();
      applyMinutes();
      update();
    })();
  </script>
</body>
</html>
